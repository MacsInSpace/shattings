#!/bin/bash

# Loosely based on <https://github.com/RichardBronosky/git-fix-whitespace>.

USAGE='[tree-ish]'
LONG_USAGE='Fixes the whitespace issues that "git-diff --check" complains about.'

SUBDIRECTORY_OK=Yes
OPTIONS_KEEPDASHDASH=
OPTIONS_SPEC="\
git fix-whitespace tree-ish

$LONG_USAGE
--
 Available options are
add          automatically add modified files to index
"

. git-sh-setup
cd_to_toplevel

set -o pipefail

SHOULD_ADD_TO_INDEX=

[ -z "${TEMP}" ] && TEMP=/tmp/

PATCH=$(mktemp ${TEMP}${0##*/}.patch.XXXXXX)


total_argc=$#
while test $# != 0
do
    case "$1" in
    --help|-h)
		usage
		;;
	--add)
		SHOULD_ADD_TO_INDEX=1
        ;;
	--)
        shift
		break
		;;
	*)
		break
        ;;
	esac
    shift
done

[ -z "$*" ] && set -- HEAD

git diff --no-ext-diff --patch-with-raw -z --binary "$@" > "$PATCH" || die Diff failed.

FILES=$(git diff --check "$@" | sed '/^[^+-][^:]*:.*/!d;s/^\([^:]*\):.*/\1/' | sort -u )

[ -z "$FILES" ] && { say "No whitespace errors detected in diff with $@." ; exit 0 ; }

say "Files with whitespace errors:"
for file in $FILES ; do
	say "    "$file
done


say "Applying reverse patch..."
git apply --whitespace=nowarn -R "$PATCH"  || die "Patch failed, unable to remove whitespace."

say "Applying patch while fixing whitespace..."
git apply --whitespace=fix "$PATCH"  || die "Patch failed, unable to remove whitespace."

[ "$SHOULD_ADD_TO_INDEX" = "1" ] && git add $FILES

rm $PATCH

say Finished.
